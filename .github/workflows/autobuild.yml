name: Automatically building EndeavourOS ISO

on:
  schedule:
    - cron: "0 0 * * 5" #once a week
    #- cron : "0 */8 * * *" #every 8 hours (3 per day)
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    permissions:
      contents: write

    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - uses: actions/checkout@v2
      
      - name: Set current date and hour as environment variable
        run: echo "NOW=$(date +'%Y-%m-%d_%H-%M')" >> $GITHUB_ENV

      - name: Update packages and install archiso
        run: "pacman -Syu --noconfirm --needed archiso git squashfs-tools wget sudo base-devel curl lftp networkmanager pipewire-jack"
                      
      - name: Add EndeavourOS Repo
        run: bash add-EndeavourOS.sh
        
      #- name: Build Calamares git packages
        #run: bash build-packages.sh
        
      - name: preparations to build ISO
        run: bash prepare-action.sh 
        
      - name: Build ISO
        run: bash build.sh
          
      - name: Upload a backup to server
        run: "curl -g -k -T EndeavourOS-ISO/out/*.sha512sum -u ${{secrets.SERVER_STRING_WEEKLY}} && curl -g -k -T EndeavourOS-ISO/out/*.iso -u ${{secrets.SERVER_STRING_WEEKLY}}"
        
      #- name: archive for release
      #  run: cp EndeavourOS-ISO/*.log EndeavourOS-ISO/out/ && cd EndeavourOS-ISO/out && tar -czvf EndeavourOS-${{ env.NOW }}-iso.tar.gz *.sha512sum *.iso *.log
    
      #- name: Upload binaries to release
      #  uses: svenstaro/upload-release-action@v2
      #  with:
      #   #repo_name: endeavouros-team/Weekly-ISO-Rebuilds
      #   repo_token: ${{ secrets.ACCESS_TOKEN }}
      #   file: EndeavourOS-ISO/out/EndeavourOS-${{ env.NOW }}-iso.tar.gz
      #   asset_name: EndeavourOS-${{ env.NOW }}-iso.tar.gz
      #   tag: ${{ env.NOW }}
      #   prerelease: false
      #   overwrite: true
      #   body: "latest weekly iso"
